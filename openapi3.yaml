openapi: 3.0.1
info:
  title: 3d-extractable-management
  description: Manage extractable records with validation and audit logging
  version: 1.0.0
  license:
    name: 3d-extractable-management repo link
    url: https://github.com/MapColonies/3d-extractable-management/

security: []

tags:
  - name: records
    description: Record extractability management
  - name: internal - audit
    description: Documentation of the the record history
  - name: internal - records
    description: Internal records extractability management
  - name: internal - users
    description: Internal users authentication and validation

paths:
  /records:
    get:
      tags:
        - records
      summary: Get all extractable records
      operationId: getRecords
      parameters:
        - name: startPosition
          in: query
          required: false
          schema:
            type: integer
            default: 1
          description: 1-based index of first record to return
        - name: maxRecords
          in: query
          required: false
          schema:
            type: integer
            default: 50
          description: Maximum number of records to return
      responses:
        '200':
          description: List of extractable records (empty array if none found)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/paginatedExtractableRecords'
              examples:
                withRecords:
                  summary: Some records exist
                  value:
                    numberOfRecords: 25
                    numberOfRecordsReturned: 2
                    nextRecord: 3
                    records:
                      - id: 123
                        recordName: rec_A
                        username: username
                        authorizedBy: john_doe
                        authorizedAt: '2026-02-04T16:26:18.055Z'
                        data:
                          kuku: 'kuku random data'
                      - id: 124
                        recordName: rec_B
                        username: another_user
                        authorizedBy: jane_doe
                        authorizedAt: '2026-02-05T10:12:11.000Z'
                        data:
                          field: 'value'
                empty:
                  summary: No records found
                  value:
                    numberOfRecords: 0
                    numberOfRecordsReturned: 0
                    nextRecord: 0
                    records: []

        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                bad_request:
                  summary: Bad request
                  value:
                    isValid: false
                    message: 'Bad request – invalid query or parameters'
                    code: 'MISSING_CREDENTIALS'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

  /records/{recordName}:
    get:
      tags:
        - records
      summary: Get extractable record by record name
      operationId: getRecord
      parameters:
        - name: recordName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Record found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/extractable-record'
              examples:
                found:
                  summary: Record exists
                  value:
                    id: 123
                    recordName: rec_A
                    username: username
                    authorizedBy: john_doe
                    authorizedAt: '2026-02-04T16:26:18.055Z'
                    data:
                      kuku: 'kuku random data'
        '404':
          description: Record not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                not_found:
                  summary: Record does not exist
                  value:
                    isValid: false
                    message: "Record with name 'rec_X' not found"
                    code: 'INVALID_RECORD_NAME'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

    post:
      tags:
        - internal - records
      summary: Create extractable record
      operationId: createRecord
      parameters:
        - name: recordName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - authorizedBy
              properties:
                username:
                  type: string
                password:
                  type: string
                authorizedBy:
                  type: string
                  description: User authorizing this record creation
                data:
                  type: object
                  additionalProperties: true
                  description: Optional metadata for the record
      responses:
        '201':
          description: Record created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/extractable-record'
              examples:
                created:
                  summary: Record created
                  value:
                    id: 123
                    recordName: rec_A
                    username: username
                    authorizedBy: john_doe
                    authorizedAt: '2026-02-04T16:26:18.055Z'
                    data:
                      kuku: 'kuku random data'
        '400':
          description: Validation failed – call POST /records/validate first
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                validation_failed:
                  summary: Validation missing
                  value:
                    isValid: false
                    message: 'Cannot create record – validation required'
                    code: 'MISSING_CREDENTIALS'
        '401':
          description: Unauthorized – invalid username or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                unauthorized:
                  summary: Invalid credentials
                  value:
                    isValid: false
                    message: 'Invalid username or password'
                    code: 'INVALID_CREDENTIALS'
        '404':
          description: Record not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                record_not_found:
                  summary: Record does not exist
                  value:
                    isValid: false
                    message: "Record with name 'rec_X' not found"
                    code: 'INVALID_RECORD_NAME'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

    delete:
      tags:
        - internal - records
      summary: Delete extractable record
      operationId: deleteRecord
      parameters:
        - name: recordName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - authorizedBy
              properties:
                username:
                  type: string
                password:
                  type: string
                authorizedBy:
                  type: string
                  description: User authorizing this deletion
      responses:
        '204':
          description: Record deleted successfully
        '404':
          description: Record not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                not_found:
                  summary: Record missing
                  value:
                    isValid: false
                    message: "Cannot delete – record 'rec_X' not found"
                    code: 'INVALID_RECORD_NAME'
        '400':
          description: Validation failed – deletion not allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                deletion_failed:
                  summary: Validation failed
                  value:
                    isValid: false
                    message: 'Deletion not allowed for this record'
                    code: 'MISSING_CREDENTIALS'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                unauthorized:
                  summary: Invalid credentials
                  value:
                    isValid: false
                    message: 'Invalid username or password'
                    code: 'INVALID_CREDENTIALS'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

  /records/validateCreate:
    post:
      tags:
        - internal - records
      summary: Validate record can be created
      operationId: validateCreate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/auth-payload-with-record'
                - type: object
                  properties:
                    multiSiteValidation:
                      type: boolean
                      description: >
                        When true, performs remote (multi-site) validation.
                        When false or omitted, validation is performed only on local site.
                      default: true
      responses:
        '200':
          description: Validation result for create
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                valid:
                  summary: Can create
                  value:
                    isValid: true
                    message: 'Record can be created'
                    code: 'SUCCESS'
        '401':
          description: Unauthorized – invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                invalid_credentials:
                  summary: Invalid credentials
                  value:
                    isValid: false
                    message: 'Invalid username or password'
                    code: 'INVALID_CREDENTIALS'
        '400':
          description: Validation failed – missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                missing_fields:
                  summary: Missing credentials or recordName
                  value:
                    isValid: false
                    message: 'Username, password, and recordName are required'
                    code: 'MISSING_CREDENTIALS'
        '404':
          description: Validation error – already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                missing_fields:
                  summary: Inappropriate recordName
                  value:
                    isValid: false
                    message: "Record 'rec_name' already exists"
                    code: 'INVALID_RECORD_NAME'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

  /records/validateDelete:
    post:
      tags:
        - internal - records
      summary: Validate record can be deleted
      operationId: validateDelete
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/auth-payload-with-record'
      responses:
        '200':
          description: Validation result for delete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                valid:
                  summary: Can delete
                  value:
                    isValid: true
                    message: 'Record can be deleted'
                    code: 'SUCCESS'
        '401':
          description: Unauthorized – invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                invalid_credentials:
                  summary: Invalid credentials
                  value:
                    isValid: false
                    message: 'Invalid username or password'
                    code: 'INVALID_CREDENTIALS'
        '400':
          description: Validation failed – missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                missing_fields:
                  summary: Missing credentials or recordName
                  value:
                    isValid: false
                    message: 'Username, password, and recordName are required'
                    code: 'MISSING_CREDENTIALS'
        '404':
          description: Validation error – doesn't exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                missing_fields:
                  summary: Inappropriate recordName
                  value:
                    isValid: false
                    message: "Record 'rec_name' doesn't exists"
                    code: 'INVALID_RECORD_NAME'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

  /audit/{recordName}:
    get:
      tags:
        - internal - audit
      summary: Get all audit logs by record name
      operationId: getAudit
      parameters:
        - name: recordName
          in: path
          required: true
          schema:
            type: string
          description: The recordName to fetch audit logs for
        - name: startPosition
          in: query
          required: false
          schema:
            type: integer
            default: 1
        - name: maxRecords
          in: query
          required: false
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of audit logs for the record (empty array if none found)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/paginatedAuditLogs'
              examples:
                withAudits:
                  summary: Audit logs exist
                  value:
                    numberOfRecords: 7
                    numberOfRecordsReturned: 2
                    nextRecord: 3
                    records:
                      - id: 1
                        recordName: rec_A
                        username: username
                        authorizedBy: john_doe
                        action: CREATE
                        authorizedAt: '2026-02-04T16:26:18.055Z'
                      - id: 2
                        recordName: rec_A
                        username: username
                        authorizedBy: jane_doe
                        action: DELETE
                        authorizedAt: '2026-02-05T16:26:18.055Z'
                empty:
                  summary: No audit logs found
                  value:
                    numberOfRecords: 0
                    numberOfRecordsReturned: 0
                    nextRecord: 0
                    records: []
        '400':
          description: Invalid recordName or request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                invalid_format:
                  summary: Invalid recordName
                  value:
                    isValid: false
                    message: 'Invalid recordName provided'
                    code: 'MISSING_CREDENTIALS'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

  /users/validate:
    post:
      tags:
        - internal - users
      summary: Validate a user's username and password
      operationId: validateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/auth-payload'
      responses:
        '200':
          description: User credentials are valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                valid:
                  summary: Credentials valid
                  value:
                    isValid: true
                    message: 'User credentials are valid'
                    code: 'SUCCESS'
        '400':
          description: Missing username or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                missing_fields:
                  summary: Missing credentials
                  value:
                    isValid: false
                    message: 'Username and password are required'
                    code: 'MISSING_CREDENTIALS'
        '401':
          description: Unauthorized – invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                invalid:
                  summary: Invalid credentials
                  value:
                    isValid: false
                    message: 'Invalid username or password'
                    code: 'INVALID_CREDENTIALS'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/validateResponse'
              examples:
                internal_error:
                  summary: Unexpected server error
                  value:
                    isValid: false
                    message: 'Internal server error, please try again later'
                    code: 'INTERNAL_ERROR'

components:
  schemas:
    validateResponse:
      type: object
      required:
        - isValid
        - message
        - code
      properties:
        isValid:
          type: boolean
        message:
          type: string
        code:
          type: string
          enum:
            - SUCCESS
            - MISSING_CREDENTIALS
            - INVALID_CREDENTIALS
            - INVALID_RECORD_NAME
            - INTERNAL_ERROR
            - INVALID_START_POSITION
            - INVALID_MAX_RECORDS

    auth-payload:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
        password:
          type: string

    auth-payload-with-record:
      type: object
      required:
        - username
        - password
        - recordName
      properties:
        username:
          type: string
        password:
          type: string
        recordName:
          type: string

    extractable-record:
      type: object
      required:
        - id
        - recordName
        - authorizedBy
      properties:
        id:
          type: integer
          format: int64
        recordName:
          type: string
        username:
          type: string
        authorizedBy:
          type: string
        authorizedAt:
          type: string
        data:
          type: object
          additionalProperties: true
          description: Metadata stored in extractable_records.data

    audit-log:
      type: object
      required:
        - id
        - recordName
        - authorizedBy
        - action
      properties:
        id:
          type: integer
          format: int64
        recordName:
          type: string
        username:
          type: string
        authorizedBy:
          type: string
        action:
          type: string
          enum: [CREATE, DELETE]
        authorizedAt:
          type: string

    paginatedExtractableRecords:
      type: object
      description: Paginated response containing extractable records.
      required:
        - numberOfRecords
        - numberOfRecordsReturned
        - records
      properties:
        numberOfRecords:
          type: integer
          description: Total number of extractable records available in the system.
          example: 60
        numberOfRecordsReturned:
          type: integer
          description: Number of records included in this response page.
          example: 50
        nextRecord:
          type: integer
          description: >
            1-based index of the next record to request for pagination.
            0 if there are no more records available.
          example: 51
        records:
          type: array
          description: List of extractable records for the current page.
          items:
            $ref: '#/components/schemas/extractable-record'

    paginatedAuditLogs:
      type: object
      description: Paginated response containing audit log entries for a specific record.
      required:
        - numberOfRecords
        - numberOfRecordsReturned
        - records
      properties:
        numberOfRecords:
          type: integer
          description: Total number of audit log entries available for the specified record.
          example: 12
        numberOfRecordsReturned:
          type: integer
          description: Number of audit log entries included in this response page.
          example: 5
        nextRecord:
          type: integer
          description: >
            1-based index of the next audit log entry to request.
            0 if there are no more audit logs available.
          example: 6
        records:
          type: array
          description: List of audit log entries for the current page.
          items:
            $ref: '#/components/schemas/audit-log'
